<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
  <title>Twistar Documentation: Simple Examples</title>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19398875-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>	
  </head>

  <body bgcolor="white">
    <h1 class="title">Simple Examples</h1>
    <p><a href="index.html">Documentation Index</a></p>
    <div class="toc"><ol><li><a href="#auto0">Initialization</a></li><li><a href="#auto1">Database Creation</a></li><li><a href="#auto2">Defining and Interacting With Objects</a></li><li><a href="#auto3">Finding Objects</a></li><li><a href="#auto4">Class Methods</a></li><li><a href="#auto5">Validations</a></li><li><a href="#auto6">DBAPI Column Objects</a></li></ol></div>
    <div class="content">
    <span/>
<p>
  Since Twistar uses Twisted, most methodand function calls willreturn a <code class="python">twisted.internet.defer.Deferred</code>
  object. You must understand the propper use of these objects before most of this documentationwill make sense.
</p>

    <h2>Initialization<a name="auto0"/></h2>
    <p>Before using Twistar a connection to the DB must first be made.  The method of connecting to the database
is to use Twisted's <code class="python">twisted.enterprise.adapi</code> module and the <code class="python">ConnectionPool</code>
object.  The <code class="python">Registry</code> class is used to keep track of that pool.  For instance, this is the 
method to specify a connection to a MySQL database:
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">enterprise</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">adbapi</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">DBPOOL</span> = <span class="py-src-variable">adbapi</span>.<span class="py-src-variable">ConnectionPool</span>(<span class="py-src-string">'MySQLdb'</span>, <span class="py-src-variable">user</span>=<span class="py-src-string">&quot;twistar&quot;</span>, <span class="py-src-variable">passwd</span>=<span class="py-src-string">&quot;apass&quot;</span>, <span class="py-src-variable">db</span>=<span class="py-src-string">&quot;twistar&quot;</span>)
</pre>
<p>
The modules implementing <a href="http://www.python.org/dev/peps/pep-0249/" shape="rect">DBAPI</a> that are supported by Twistar are:
<ul>
  <li><a href="http://sourceforge.net/projects/mysql-python/" shape="rect">MySQLdb</a> (MySQL interface)</li>
  <li><a href="http://initd.org/psycopg/" shape="rect">psycopg2</a> (PostgreSQL interface)</li>
  <li><a href="http://docs.python.org/library/sqlite3.html" shape="rect">sqlite3</a> (SQLite interface)</li>
</ul>
</p>

<h2>Database Creation<a name="auto1"/></h2>
<p>Twistar does not provide DB creation / migration functionality beyond asynchronously making SQL queries.
There are plenty of utilities in existance to provide these capabilities.  If you need to create tables 
in an asynchronous manner, you can always <a href="lowlevel.html" shape="rect">execute the creation SQL directly</a>.
</p>
<p>
Objects will assume that the plural version of the object's class name will be the table name.  For instance,
if the class name is Person, then the tablename should be People.  If it is Chicken, the tablename should be
Chickens.  If you want to manually specify a tablename, you can do that with the 
<code class="python">TABLENAME</code> class variable (see the 
<code class="python">DBObject</code> definition).
</p>
<p>
Column names should have no spaces (with words separated by a <q>_</q>) and should generally be lower case.
All object tables (that don't describe <a href="relationship_examples.html" shape="rect">relationships</a>) should have
an auto-incrementing integer column named <q>id</q>.
</p>

<h2>Defining and Interacting With Objects<a name="auto2"/></h2>
<p>
Object's representing rows in a database need only extend the 
<code class="python">DBObject</code> class.
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-keyword">pass</span>
</pre>
<p>
Assuming that the <q>users</q> table has some VARCHAR fields like first_name and last_name and, say,
and integer field named age (along with the required auto-incrementing integer column named
<q>id</q>), then object properties can be assigned:
</p>

<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">done</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;A user has just been saved with id: %i&quot;</span> % <span class="py-src-variable">user</span>.<span class="py-src-variable">id</span>

<span class="py-src-variable">u</span> = <span class="py-src-variable">User</span>()
<span class="py-src-variable">u</span>.<span class="py-src-variable">first_name</span> = <span class="py-src-string">&quot;John&quot;</span>
<span class="py-src-variable">u</span>.<span class="py-src-variable">last_name</span> = <span class="py-src-string">&quot;Smith&quot;</span>
<span class="py-src-variable">u</span>.<span class="py-src-variable">age</span> = <span class="py-src-number">25</span>
<span class="py-src-variable">u</span>.<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">done</span>)

<span class="py-src-comment"># The following is equivalent</span>
<span class="py-src-variable">u</span> = <span class="py-src-variable">User</span>(<span class="py-src-variable">first_name</span>=<span class="py-src-string">&quot;John&quot;</span>, <span class="py-src-variable">last_name</span>=<span class="py-src-string">&quot;Smith&quot;</span>, <span class="py-src-variable">age</span>=<span class="py-src-number">25</span>)
<span class="py-src-variable">u</span>.<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">done</span>)
</pre>

<p>
Any additional properties that are set that don't correspond to column names are ignored on the save.  For instance,
had a <q>middle_name</q> property been set for the user it would have simply been ignored when the object was saved.
</p>

<p>
Methods you would traditionally find in an active record style RDBMS are also available, for instance to 
test for existance and delete an object instance.
</p>

<h2>Finding Objects<a name="auto3"/></h2>
<p>To find an object, use the class's <code class="python">find</code> method.  It accepts a number of
arguments to group, sort, and limit results.  The simplest way to use the method is to get an object 
instance by id.  For instance, if we wanted to find the user with an id of 1:
</p>
<pre class="python"><p class="py-linenumber">1
</p><span class="py-src-variable">User</span>.<span class="py-src-variable">find</span>(<span class="py-src-number">1</span>).<span class="py-src-variable">addCallback</span>(...)
</pre>
<p>
Additional constriants can be specified using the <code class="py-src-parameter">where</code>
paramter and others:
</p>
<pre class="python"><p class="py-linenumber">1
</p><span class="py-src-variable">User</span>.<span class="py-src-variable">find</span>(<span class="py-src-variable">where</span>=[<span class="py-src-string">'first_name = ? AND last_name = ?'</span>, <span class="py-src-string">&quot;John&quot;</span>, <span class="py-src-string">&quot;Smith&quot;</span>], <span class="py-src-variable">limit</span>=<span class="py-src-number">1</span>).<span class="py-src-variable">addCallback</span>(...)
</pre>
<p>There are many more options, all of which are described on the
<code class="python">DBObject</code> API reference page.
</p>
<p>
One thing to note: if either <code class="py-src-parameter">limit</code> is set to 1 or the query
is by <code class="py-src-parameter">id</code>, then the resulting deferred will return either the 
found object or <code class="python">None</code> if not found.  Otherwise, an array is returned
containing the found objects.
</p>

<h2>Class Methods<a name="auto4"/></h2>
<p>
Additional class methods (other than find) includes ones for getting an array of all objects
(using the <code class="python">all()</code> method), deleting all instances 
(using the <code class="python">deleteAll()</code> method), and determining whether or not
any particular objects exist (using the <code class="python">exists()</code> method).  For instance:
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">printAll</span>(<span class="py-src-parameter">users</span>):
     <span class="py-src-keyword">for</span> <span class="py-src-variable">user</span> <span class="py-src-keyword">in</span> <span class="py-src-variable">users</span>:
          <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;First: %s Last: %s&quot;</span> % (<span class="py-src-variable">user</span>.<span class="py-src-variable">first_name</span>, <span class="py-src-variable">user</span>.<span class="py-src-variable">last_name</span>)

<span class="py-src-variable">User</span>.<span class="py-src-variable">all</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">printAll</span>)


<span class="py-src-keyword">def</span> <span class="py-src-identifier">printExists</span>(<span class="py-src-parameter">doesExist</span>):
     <span class="py-src-keyword">if</span> <span class="py-src-variable">doesExist</span>:
          <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;User exists!&quot;</span>
     <span class="py-src-keyword">else</span>:
          <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;User does not exist.&quot;</span>

<span class="py-src-variable">User</span>.<span class="py-src-variable">exists</span>([<span class="py-src-string">'first_name = ?'</span>, <span class="py-src-string">&quot;John&quot;</span>]).<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">printExists</span>)
</pre>


<h2>Validations<a name="auto5"/></h2>
<p>
Twistar also supports validations.  Validations describe constraints on an objects
parameters.  If those constraints are violated, then an object will not be saved (this
includes both creating and updating).  In such a case a special parameter in the object
keeps track of the errors and the messages.
</p>
<p>
As an example, let's say that we want all users to always have a first name set and a last
name that has a length between 1 and 256 characters.  First, we describe the class 
<code class="python">User</code> as above and then add restrictions on it.
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
</p><span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-keyword">pass</span>
<span class="py-src-variable">User</span>.<span class="py-src-variable">validatesPresenceOf</span>(<span class="py-src-string">'first_name'</span>)
<span class="py-src-variable">User</span>.<span class="py-src-variable">validatesLengthOf</span>(<span class="py-src-string">'last_name'</span>, <span class="py-src-variable">range</span>=<span class="py-src-variable">xrange</span>(<span class="py-src-number">1</span>,<span class="py-src-number">257</span>))
</pre>
<p>
If we look at an object without those parameters, it will be invalid:
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
5
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">vcheck</span>(<span class="py-src-parameter">isValid</span>, <span class="py-src-parameter">object</span>):
     <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isValid</span>:
          <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;Object not valid: %s&quot;</span> % <span class="py-src-variable">str</span>(<span class="py-src-variable">u</span>.<span class="py-src-variable">errors</span>)
<span class="py-src-variable">u</span> = <span class="py-src-variable">User</span>()
<span class="py-src-variable">u</span>.<span class="py-src-variable">isValid</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">vcheck</span>, <span class="py-src-variable">u</span>)
</pre>
<p>
If we try to save an invalid object, nothing happens:
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
5
6
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">checkUser</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-keyword">print</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">id</span> <span class="py-src-comment"># this will be None</span>
     <span class="py-src-keyword">print</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">errors</span>.<span class="py-src-variable">errorsFor</span>(<span class="py-src-string">'first_name'</span>)
     <span class="py-src-keyword">print</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">errors</span>.<span class="py-src-variable">errorsFor</span>(<span class="py-src-string">'last_name'</span>)
     <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;There were %d errors&quot;</span> % <span class="py-src-variable">len</span>(<span class="py-src-variable">user</span>.<span class="py-src-variable">errors</span>)
<span class="py-src-variable">User</span>().<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">checkUser</span>)
</pre>
<p>
You can also create your own validity function.  It should accept an object as 
a parameter and then add errors as necessary.  It can return a <code class="python">Deferred</code>
if necessary; the return value from the function will be ignored.
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">myValidator</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-keyword">if</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">first_name</span> != <span class="py-src-string">&quot;fred&quot;</span>:
          <span class="py-src-variable">user</span>.<span class="py-src-variable">errors</span>.<span class="py-src-variable">add</span>(<span class="py-src-string">'first_name'</span>, <span class="py-src-string">&quot;must be Fred!&quot;</span>)
<span class="py-src-variable">User</span>.<span class="py-src-variable">addValidator</span>(<span class="py-src-variable">myValidator</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">test</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-comment"># This will print &quot;First Name must be Fred!&quot;</span>
     <span class="py-src-keyword">print</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">errors</span> 
     <span class="py-src-keyword">print</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">id</span> <span class="py-src-comment"># None</span>
<span class="py-src-variable">User</span>(<span class="py-src-variable">first_name</span>=<span class="py-src-string">'not fred'</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">test</span>)
</pre>
<p>
For more information see the <code class="python">Validator</code> and
<code class="python">Errors</code> classes.
</p>

<h2>DBAPI Column Objects<a name="auto6"/></h2>
<p>
The <a href="http://www.python.org/dev/peps/pep-0249/" shape="rect">DBAPI</a> specification requires that 
implementing modules define classes corresponding to certain column types (like 
the class <code class="python">Date</code>).  Twistar provides a driver agnostic method for 
using those classes using the <code class="python">Registry</code> class:
</p>
<pre class="python"><p class="py-linenumber">1
2
</p><span class="py-src-variable">Date</span> = <span class="py-src-variable">Registry</span>.<span class="py-src-variable">getDBAPIClass</span>(<span class="py-src-string">&quot;Date&quot;</span>)
<span class="py-src-variable">bob</span> = <span class="py-src-variable">User</span>(<span class="py-src-variable">first_name</span>=<span class="py-src-string">&quot;Bob&quot;</span>, <span class="py-src-variable">dob</span>=<span class="py-src-variable">Date</span>(<span class="py-src-number">1970</span>, <span class="py-src-number">1</span>, <span class="py-src-number">1</span>))
</pre>
<p>
Then, regardless of which DBAPI module you are using, your code will always be using the correct
<code class="python">Date</code> class.
</p>
  </div>

    <p><a href="index.html">Documentation Index</a></p>
  </body>
</html>