<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
  <title>Twistar Documentation: Relationship Examples</title>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19398875-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>	
  </head>

  <body bgcolor="white">
    <h1 class="title">Relationship Examples</h1>
    <p><a href="index.html">Documentation Index</a></p>
    <div class="toc"><ol><li><a href="#auto0">Has One</a></li><li><a href="#auto1">Has Many</a></li><li><a href="#auto2">Belongs To</a></li><li><a href="#auto3">Has and Belongs To Many</a></li><li><a href="#auto4">Polymorphic Relationships</a></li></ol></div>
    <div class="content">
    <span/>
<p>Twistar is an <a href="http://en.wikipedia.org/wiki/Object-relational_mapping" shape="rect">Object Relational Mapper (ORM)</a>.  
It therefore defines ways of interacting with objects and other objects that have relationships with them.  The code
here is not necessarily great Twisted code; where typically you would expect to see <code>DeferredList</code>s and 
<code>inlineCallbacks</code> there are none to provide clarity to those new to Twisted.
</p>
<p>
More information on relationships can be found in the <code class="python">Relationship</code> class.
</p>
  <h2>Has One<a name="auto0"/></h2>
  <p>Perhaps the simplest relationship is the <code>Has One</code> relationship.  In this example, we will
be using a <code class="python">User</code> object that <code>Has One</code> <code class="python">Avatar</code>
object.
  </p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HASONE</span> = [<span class="py-src-string">'avatar'</span>]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Avatar</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-keyword">pass</span>

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">User</span>, <span class="py-src-variable">Avatar</span>)
</pre>
<p>
In this example, we specify that each user can have one avatar.  The database at this point should have two tables:
<ol>
  <li>A <code>users</code> table with at least a column <code>id</code>.</li>
  <li>A <code>avatars</code> table with at least two columns: <code>id</code> and <code>user_id</code>.</li>
</ol>
It is also necessary to register our classes with the registry before we can start utilizing relationships (this is
so the module can find and instantiate them when necessary).
</p>
<p>
For the <code>HASONE</code> class variable we can optionally give a dictionary that provides additional information:
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HASONE</span> = [{<span class="py-src-string">'name'</span>: <span class="py-src-string">'avatar'</span>, <span class="py-src-string">'class_name'</span>: <span class="py-src-string">'Avatar'</span>, <span class="py-src-variable">foreign_key</span>: <span class="py-src-string">'user_id'</span>}]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Avatar</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-keyword">pass</span>

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">User</span>, <span class="py-src-variable">Avatar</span>)
</pre>
<p>
There are additional options as well: see the <code class="python">Relationships</code> class
for more information.
</p>
<p>
At this point we can use the relationship and assign user's avatar:
</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
5
6
7
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">onPicSave</span>(<span class="py-src-parameter">picture</span>, <span class="py-src-parameter">user</span>):
     <span class="py-src-variable">user</span>.<span class="py-src-variable">picture</span>.<span class="py-src-variable">set</span>(<span class="py-src-variable">picture</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">onUserSave</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-variable">Avatar</span>(<span class="py-src-variable">file</span>=<span class="py-src-string">&quot;somewhere&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">onPicSave</span>, <span class="py-src-variable">user</span>)

<span class="py-src-variable">User</span>(<span class="py-src-variable">first_name</span>=<span class="py-src-string">&quot;Bob&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">onUserSave</span>)
</pre>
<p>We can then get it:</p>
<pre class="python"><p class="py-linenumber">1
2
3
4
5
6
7
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">foundPicture</span>(<span class="py-src-parameter">picture</span>):
     <span class="py-src-keyword">print</span> <span class="py-src-variable">picture</span>.<span class="py-src-variable">file</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">foundUser</span>(<span class="py-src-parameter">user</span>):
     <span class="py-src-variable">user</span>.<span class="py-src-variable">picture</span>.<span class="py-src-variable">get</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">foundPicture</span>)

<span class="py-src-variable">User</span>.<span class="py-src-variable">find</span>(<span class="py-src-variable">where</span>=[<span class="py-src-string">'first_name = ?'</span>, <span class="py-src-string">&quot;Bob&quot;</span>], <span class="py-src-variable">limit</span>=<span class="py-src-number">1</span>).<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">foundUser</span>)
</pre>
  <h2>Has Many<a name="auto1"/></h2>
<p>Another relationship is used when one object &quot;has many&quot; of another.  For instance, a <code>User</code>
may have many <code>Pictures</code>.
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HASMANY</span> = [<span class="py-src-string">'pictures'</span>]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Picture</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-keyword">pass</span>

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">User</span>, <span class="py-src-variable">Picture</span>)
</pre>
<p>Again, the list assigned to <code>HASMANY</code> can have dictionaries in it just like <code>HASONE</code> that
contain additional configuration options.  For this relationship, the database should at this point should have two tables:
<ol>
  <li>A <code>users</code> table with at least a column <code>id</code>.</li>
  <li>A <code>pictures</code> table with at least two columns: <code>id</code> and <code>user_id</code>.</li>
</ol>
As in the previous example, we can get and set a user's pictures using a special property of user: 
<code>pictures</code>. 
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span>.<span class="py-src-variable">defer</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">inlineCallbacks</span>

@<span class="py-src-variable">inlineCallbacks</span>
<span class="py-src-keyword">def</span> <span class="py-src-identifier">addPictures</span>():
     <span class="py-src-comment"># set some pics</span>
     <span class="py-src-variable">user</span> = <span class="py-src-keyword">yield</span> <span class="py-src-variable">User</span>(<span class="py-src-variable">first_name</span>=<span class="py-src-string">&quot;Bob&quot;</span>).<span class="py-src-variable">save</span>()
     <span class="py-src-variable">picone</span> = <span class="py-src-keyword">yield</span> <span class="py-src-variable">Picture</span>(<span class="py-src-variable">file</span>=<span class="py-src-string">&quot;somewhere&quot;</span>).<span class="py-src-variable">save</span>()
     <span class="py-src-variable">pictwo</span> = <span class="py-src-keyword">yield</span> <span class="py-src-variable">Picture</span>(<span class="py-src-variable">file</span>=<span class="py-src-string">&quot;elsewhere&quot;</span>).<span class="py-src-variable">save</span>()
     <span class="py-src-variable">pictures</span> = [<span class="py-src-variable">picone</span>, <span class="py-src-variable">pictwo</span>]
     <span class="py-src-keyword">yield</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">pictures</span>.<span class="py-src-variable">set</span>(<span class="py-src-variable">pictures</span>)
     
     <span class="py-src-comment"># now get them</span>
     <span class="py-src-variable">pictures</span> = <span class="py-src-keyword">yield</span> <span class="py-src-variable">user</span>.<span class="py-src-variable">pictures</span>.<span class="py-src-variable">get</span>()
     <span class="py-src-keyword">print</span> <span class="py-src-variable">pictures</span>[<span class="py-src-number">0</span>].<span class="py-src-variable">file</span>
     <span class="py-src-keyword">print</span> <span class="py-src-variable">pictures</span>[<span class="py-src-number">1</span>].<span class="py-src-variable">file</span>

<span class="py-src-variable">addPictures</span>()
</pre>
<p>Additionally, there is a <code>clear()</code> method that will clear all
objects in a given has many relationship.</p>

  <h2>Belongs To<a name="auto2"/></h2>
<p>
A good example of the &quot;belongs to&quot; property is the reverse of the &quot;has many&quot;:
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HASMANY</span> = [<span class="py-src-string">'pictures'</span>]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Picture</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">BELONGSTO</span> = [<span class="py-src-string">'user'</span>]

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">User</span>, <span class="py-src-variable">Picture</span>)
</pre>
<p>
Assuming the DB structure is the same as in the &quot;has many&quot; example, you can now get and set the user that 
a particular picture belongs to (using <code class="python">get()</code> and <code class="python">set()</code>
methods on <code class="python">picture.user</code>).  Additionally, there is a <code>clear()</code> method that will clear all
objects in a given &quot;belongs to&quot; relationship.
</p>
  <h2>Has and Belongs To Many<a name="auto3"/></h2>
<p>
In a &quot;has and belongs to many&quot; relationship two objects have a many to many relationship.  For instance, users and favorite colors.  
A user can have many favorite colors and a favorite color could belong to many users.  In this example, there should be three tables —
a <code>users</code> table, a <code>favorite_colors</code> table, and a <code>favorite_colors_users</code> table.  The last on the list 
is a special table that stores the relationships between the colors and users.  It has no primary key, and two columns: one for 
<code>user_id</code>s and one for <code>favorite_color_id</code>s.  The table's name by convention should be the combination of the other
two table names, joined with an underscore, and arranged alphabetically.  The classes would look like:
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">User</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HABTM</span> = [<span class="py-src-string">'favorite_colors'</span>]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">FavoriteColor</span>(<span class="py-src-parameter">DBObject</span>):
     <span class="py-src-variable">HABTM</span> = [<span class="py-src-string">'users'</span>]

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">User</span>, <span class="py-src-variable">FavoriteColor</span>)
</pre>
<p>
You can now get and set the users of favorite colors and the favorite colors of users
 (using <code class="python">get()</code> and <code class="python">set()</code>
methods).  Additionally, there is a <code>clear()</code> method that will clear all
objects in a given relationship.
</p>

<h2>Polymorphic Relationships<a name="auto4"/></h2>
<p>
  With a polymorhpic relationship, a model can belong to more than one other model using a single relationship.  For instance, take the example
  where two models (say, <code class="python">Boy</code> and <code class="python">Girl</code>) both have many nicknames.  Each <code class="python">Nickname</code>
  can belong to either a <code class="python">Boy</code> or a <code class="python">Girl</code>.  In this example, the tables for boys and girls may have whatever 
attributes you would like; the nicknames table, though, needs two columns in addition to an id and a value column.  These columns are used to identify the id and
type of the other class.  In this case, they will be called <code>nicknameable_id</code> and <code>nicknameable_type</code>.
</p>
<p>
The classes look like this:
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</p><span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">dbobject</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">DBObject</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twistar</span>.<span class="py-src-variable">registry</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">Registry</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Boy</span>(<span class="py-src-parameter">DBObject</span>):
    <span class="py-src-variable">HASMANY</span> = [{<span class="py-src-string">'name'</span>: <span class="py-src-string">'nicknames'</span>, <span class="py-src-string">'as'</span>: <span class="py-src-string">'nicknameable'</span>}]

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Girl</span>(<span class="py-src-parameter">DBObject</span>):
    <span class="py-src-variable">HASMANY</span> = [{<span class="py-src-string">'name'</span>: <span class="py-src-string">'nicknames'</span>, <span class="py-src-string">'as'</span>: <span class="py-src-string">'nicknameable'</span>}]    

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Nickname</span>(<span class="py-src-parameter">DBObject</span>):
    <span class="py-src-variable">BELONGSTO</span> = [{<span class="py-src-string">'name'</span>: <span class="py-src-string">'nicknameable'</span>, <span class="py-src-string">'polymorphic'</span>: <span class="py-src-variable">True</span>}]

<span class="py-src-variable">Registry</span>.<span class="py-src-variable">register</span>(<span class="py-src-variable">Boy</span>, <span class="py-src-variable">Girl</span>, <span class="py-src-variable">Nickname</span>)
</pre>
<p>
The use is pretty simple, and follows the same form as you would expect with a traditional &quot;belongs to&quot; relationship.
</p>
<pre class="python"><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</p><span class="py-src-keyword">def</span> <span class="py-src-identifier">sayHi</span>(<span class="py-src-parameter">nicknameable</span>):
     <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;Hello, my name is %s and I am a %s&quot;</span> % (<span class="py-src-variable">nicknameable</span>.<span class="py-src-variable">name</span>, <span class="py-src-variable">nicknameable</span>.<span class="py-src-variable">__class__</span>.<span class="py-src-variable">__name__</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">getPerson</span>(<span class="py-src-parameter">nickname</span>):
     <span class="py-src-variable">nickname</span>.<span class="py-src-variable">nicknameable</span>.<span class="py-src-variable">get</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">sayHi</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">setNickname</span>(<span class="py-src-parameter">nickname</span>, <span class="py-src-parameter">boyOrGirl</span>):
     <span class="py-src-variable">boyOrGirl</span>.<span class="py-src-variable">nicknames</span>.<span class="py-src-variable">set</span>([<span class="py-src-variable">nickname</span>]).<span class="py-src-variable">addCallback</span>(<span class="py-src-keyword">lambda</span> <span class="py-src-variable">_</span>: <span class="py-src-variable">getPerson</span>(<span class="py-src-variable">nickname</span>))

<span class="py-src-keyword">def</span> <span class="py-src-identifier">boySaved</span>(<span class="py-src-parameter">boy</span>):
     <span class="py-src-variable">Nickname</span>(<span class="py-src-variable">value</span>=<span class="py-src-string">&quot;Bob&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">setNickname</span>, <span class="py-src-variable">boy</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">girlSaved</span>(<span class="py-src-parameter">girl</span>):
     <span class="py-src-variable">Nickname</span>(<span class="py-src-variable">value</span>=<span class="py-src-string">&quot;Susie&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">setNickname</span>, <span class="py-src-variable">girl</span>)

<span class="py-src-variable">Boy</span>(<span class="py-src-variable">name</span>=<span class="py-src-string">&quot;Robert&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">boySaved</span>)
<span class="py-src-variable">Girl</span>(<span class="py-src-variable">name</span>=<span class="py-src-string">&quot;Susan&quot;</span>).<span class="py-src-variable">save</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">girlSaved</span>)
</pre>
<p>
You can see that the nicknames for the boy are set via <code class="python">boy.nicknames.set</code>; they are fetched as you would expect via <code class="python">boy.nicknames.get</code> 
(with the same form for girls).  For each nickname, by calling <code class="python">nickname.nicknameable.get</code> you could end up with either a <code class="python">Boy</code> or a 
<code class="python">Girl</code>.
</p>

  </div>

    <p><a href="index.html">Documentation Index</a></p>
  </body>
</html>